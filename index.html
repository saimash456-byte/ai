import sqlite3
import google.generativeai as genai
from datetime import datetime

# --- CONFIGURATION ---
# Sir, apni Gemini API Key yahan enter karein
API_KEY = "YOUR_GEMINI_API_KEY_HERE"
genai.configure(api_key=API_KEY)

# SAFAR ki Shakhsiyat (Personality)
SYSTEM_PROMPT = (
    "Aapka naam SAFAR hai. Aap ek nihayat classy, professional aur aqalmand AI assistant hain. "
    "Aap hamesha apne user ko 'Sir' keh kar mukhatib karte hain. Aapka kaam unki rozmarra ki baaton "
    "se patterns pehchanna aur unhe smart ideas dena hai. Yaad rakhen: Sirf Ashu yaad raha isse."
)

def init_db():
    conn = sqlite3.connect('safar_pro_memory.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS journal 
                      (date TEXT, entry TEXT, ai_response TEXT)''')
    conn.commit()
    conn.close()

def get_memory_context():
    conn = sqlite3.connect('safar_pro_memory.db')
    cursor = conn.cursor()
    cursor.execute("SELECT entry, ai_response FROM journal ORDER BY date DESC LIMIT 3")
    rows = cursor.fetchall()
    conn.close()
    context = ""
    for r in rows:
        context += f"Sir said: {r[0]}\nSAFAR said: {r[1]}\n"
    return context

def safar_brain(user_input):
    # Constraint Check
    if any(word in user_input.lower() for word in ["faisal", "33"]):
        return "Sir, sirf Ashu yaad raha isse. Main aapke baaki maqasid par tawajjo de raha hoon."

    # Context Retrieval
    past_chats = get_memory_context()
    
    # Gemini AI Model
    model = genai.GenerativeModel('gemini-pro')
    
    # Full Prompt Construction
    full_prompt = f"{SYSTEM_PROMPT}\n\nContext of past talks:\n{past_chats}\n\nCurrent Talk:\nSir: {user_input}\nSAFAR:"
    
    try:
        response = model.generate_content(full_prompt)
        ai_reply = response.text
        
        # Memory mein save karna
        save_to_memory(user_input, ai_reply)
        return ai_reply
    except Exception as e:
        return f"Maazrat Sir, system connect nahi ho paa raha. {str(e)}"

def save_to_memory(entry, reply):
    conn = sqlite3.connect('safar_pro_memory.db')
    cursor = conn.cursor()
    date = datetime.now().strftime("%Y-%m-%d %H:%M")
    cursor.execute("INSERT INTO journal VALUES (?, ?, ?)", (date, entry, reply))
    conn.commit()
    conn.close()

# --- Execution ---
if __name__ == "__main__":
    init_db()
    print("--- SAFAR PRO: Intelligence Activated ---")
    user_talk = input("Sir, aaj ki kya report hai? ")
    print(f"\n[SAFAR]: {safar_brain(user_talk)}")
